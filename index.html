<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steal a Brainrot - ONLINE</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#0f1520;--muted:#99a3b0;--text:#e8eef8;--brand:#6ad06a;--danger:#ff5277;--accent:#7aa7ff;--gold:#ffd166;
      --card:#121a27;--card-border:#1f2a3b;--shadow:0 10px 25px rgba(0,0,0,.35);
      
      /* Rarity Colors */
      --rare-bg: #112a42; --rare-fg: #7bbdff; --rare-border: #1b415f;
      --epic-bg: #2a1c40; --epic-fg: #d59cff; --epic-border: #412c67;
      --legendary-bg: #3c2e12; --legendary-fg: #ffd166; --legendary-border: #6e4b12;
      --mythic-bg: #25183c; --mythic-fg: #caa9ff; --mythic-border: #3c2a62;
      --brainrotgod-bg: #3a0f15; --brainrotgod-fg: #ff9aa6; --brainrotgod-border: #5a1a22;
      --secret-bg: #3a0f15; --secret-fg: #ff9aa6; --secret-border: #5a1a22; /* Using Brainrot God as fallback */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(60% 100% at 50% 0%, #101827 0%, #0b0f14 60%);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

    header{position:sticky;top:0;z-index:5;background:rgba(10,14,20,.8);backdrop-filter:blur(8px);
      border-bottom:1px solid #1b2636; box-shadow: var(--shadow);}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:1200px;margin:0 auto;padding:14px 16px}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--brand);box-shadow:0 0 0 4px rgba(106,208,106,.15)}
    .brand h1{font-size:16px;margin:0;font-weight:700;color:#d7e6ff;letter-spacing:.2px}
    .stats{display:flex;gap:18px;align-items:center}
    .pill{display:flex;gap:8px;align-items:center;background:var(--panel);border:1px solid #1a2435;border-radius:999px;padding:8px 12px;box-shadow:var(--shadow)}
    .pill small{color:var(--muted)}
    .pill b{font-variant-numeric:tabular-nums}
    .btn{cursor:pointer;border:none;border-radius:999px;padding:8px 12px;font-weight:700;background:var(--panel);border:1px solid #1a2435;color:var(--muted)}
    .btn-reset{background:var(--danger);color:#fff; border: none;}

    main{max-width:1200px;margin:20px auto;padding:0 16px 40px;}
    .filters-container{display: flex; justify-content: space-between; align-items: center; margin:8px 0 14px; flex-wrap: wrap;}
    .filters{display:flex;gap:8px;flex-wrap:wrap;}
    .chip{border:1px solid #1a2435;background:var(--panel);padding:6px 10px;border-radius:999px;color:#9fb0c4;cursor:pointer}
    .chip.active{outline:2px solid #2844aa;color:#cfe2ff}
    .slots-counter{color: var(--muted); font-size: 14px;}

    .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));align-items:start}

    .card{position:relative;background:var(--card);border:1px solid var(--card-border);border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .thumb{width:100%;aspect-ratio:1/1;display:grid;place-items:center;background:linear-gradient(180deg,#0e1420,#0a0f16)}
    .thumb img{width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 6px 14px rgba(0,0,0,.55))}
    .placeholder{width:72%;height:72%;display:grid;place-items:center;border-radius:14px;background:#1a2435;color:#9fb4ff;font-weight:800;letter-spacing:.3px}

    .meta{padding:10px 12px;background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.15))}
    .name{font-weight:800;margin:0 0 6px;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{font-size:12px;color:#b6c2d4;display:flex;gap:10px;flex-wrap:wrap}
    .buybar{display:flex;gap:8px;align-items:center;margin-top:10px}
    .buybtn{flex:1;border:none;padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer;background:#162033;border:1px solid #22314b;color:#d6e3ff}
    .buybtn:disabled{opacity:.5;cursor:not-allowed}
    .buybtn:not(:disabled) { background:#09AD05; color:#fff; }
    .badge{position:absolute;left:10px;top:10px;background:#60a5fa;color:#001218;font-weight:900;border-radius:999px;padding:4px 8px;font-size:11px;box-shadow:0 4px 12px rgba(0,0,0,.4)}
    .qty{position:absolute;right:10px;top:10px;background:#ffd166;color:#1a1200;font-weight:900;border-radius:999px;padding:2px 8px;font-size:11px;box-shadow:0 4px 12px rgba(0,0,0,.4)}
    .common .badge{background:#48bb78}
    .rare .badge{background:var(--rare-fg)}
    .epic .badge{background:var(--epic-fg)}
    .legendary .badge{background:var(--legendary-fg);color:#1a1200}
    .mythic .badge{background:var(--mythic-fg);color:#16042a}
    .brainrotgod .badge{background:var(--brainrotgod-fg);color:#280208}
    .secret .badge{background:linear-gradient(45deg, #fde047, #f97316, #ef4444, #ec4899, #8b5cf6); color:#fff; text-shadow:0 1px 2px #000;}
    .og .badge { background: linear-gradient(45deg, #a855f7, #ec4899, #fde047); color: #fff; text-shadow: 0 1px 2px #000;}

    /* Modal Styles */
    .modal{position:fixed;z-index:10;left:0;top:0;width:100%;height:100%;overflow:auto;
      background:rgba(11,15,20,.8);backdrop-filter:blur(4px);padding-top:60px;animation:fadein .3s}
    @keyframes fadein{from{opacity:0}to{opacity:1}}
    .modal-content{background:var(--panel);margin:2% auto;padding:20px;border:1px solid var(--card-border);
      width:90%;max-width:1100px;border-radius:16px;position:relative;}
    .close-btn{color:#aaa;position:absolute;top:10px;right:20px;font-size:28px;font-weight:bold;cursor:pointer;}
    .close-btn:hover{color:white;}
    
    /* Rebirth Modal Styles */
    #rebirthModal .modal-content { text-align: center; }
    #rebirthInfo { display: inline-flex; text-align: left; gap: 20px; background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 20px; }
    .rebirth-level-list { display: flex; flex-direction: column; gap: 10px; max-height: 60vh; overflow-y: auto; padding-right: 10px;}
    .rebirth-item { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--card-border); text-align: center; }
    .rebirth-item h3 { margin: 0 0 10px; color: var(--accent); }
    .rebirth-item ul { list-style: none; padding: 0; margin: 0 0 10px; }
    .rebirth-item ul li { margin-bottom: 5px; }
    .met { color: var(--brand); }
    .unmet { color: var(--muted); }
    .rebirth-reqs { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
    .rebirth-char-card { width: 80px; text-align: center; font-size: 11px; }
    .rebirth-char-card img { width: 100%; height: 80px; object-fit: contain; border-radius: 8px; margin-bottom: 4px; background: #000; }
    .rebirth-char-card.unmet img { filter: brightness(0.4); }
    .rebirth-action .btn { background: var(--brand); color: #000; padding: 12px 20px; }
    .cash-requirement { position: relative; background-color: #0a0f16; border: 1px solid var(--card-border); border-radius: 999px; overflow: hidden; padding: 8px 12px; margin-bottom: 10px; }
    .cash-requirement .progress-fill { position: absolute; top: 0; left: 0; height: 100%; background-color: var(--brand); opacity: 0.2; transition: width 0.3s ease; }
    .cash-requirement .progress-text { position: relative; z-index: 1; }
    .cash-requirement.met .progress-text { color: var(--brand); font-weight: bold; }
    .rebirth-warning { color: var(--danger); font-weight: bold; margin-bottom: 15px; }

    footer{max-width:1200px;margin:10px auto 34px;padding:0 16px;color:#99a3b0;font-size:13px}
    .card.locked { filter: grayscale(1) brightness(0.3); pointer-events: none; }

    /* === Floating Action Button === */
    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: none;
      box-shadow: var(--shadow);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: background-color 0.2s, transform 0.2s;
    }
    .fab:hover {
      background-color: #92baff; /* Lighter accent */
    }
    .fab:active {
      transform: scale(0.95);
    }
    .fab svg {
      width: 28px;
      height: 28px;
    }
  </style>
  <style>
    /* === Craft Machine (Simplified) === */
    .modal-content.craft { max-width: 1100px; }
    .craft-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .craft-timer{color:var(--muted);font-weight:700}
    .craft-body{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .craft-left{background:var(--card);border:1px solid var(--card-border);border-radius:12px;padding:10px;max-height:70vh;overflow:auto}

    /* Craft List Item (Left Panel) */
    .craft-list-item{
        padding:8px;
        border:1px solid var(--card-border);
        border-radius:10px;
        background:var(--panel);
        cursor:pointer;
        margin-bottom:8px;
        transition: background-color 0.2s;
        display:flex; 
        align-items:center; 
        gap:10px;
    }
    .craft-list-item:hover { background-color: var(--card); }
    .craft-list-item.active{ outline:2px solid var(--accent); }
    .craft-list-item .icon{
        width:36px; height:36px;
        border-radius:8px;
        background:#0c1422;
        border:1px solid #1a2940;
        overflow:hidden;
        flex-shrink: 0;
    }
    .craft-list-item .icon img{ width:100%; height:100%; object-fit:contain; }
    .craft-list-item .name{ font-weight:800; }

    /* Right Panel */
    .craft-right{
        background:var(--card); border:1px solid var(--card-border);
        border-radius:12px; padding:14px;
        min-height:460px; text-align: center;
    }
    .craft-detail h3{ text-align: center; margin: 0 0 12px; font-size: 20px; }
    .craft-stats{display:flex;gap:12px;flex-wrap:wrap;font-size:13px;color:var(--muted); justify-content: center; margin-bottom: 16px;}
    .craft-main-image {
        display: block; width: 140px; height: 140px;
        object-fit: contain; background: #000;
        border-radius: 14px; margin: 0 auto 12px;
        border: 1px solid var(--card-border);
    }
    .craft-reqs{margin-top:12px}
    .craft-reqs h4{margin:0 0 8px}
    .slot-row{display:flex;gap:10px;flex-wrap:wrap; justify-content: center;}
    .slot{
        width:110px; background:var(--panel);
        border:1px solid var(--card-border); border-radius:10px;
        padding:8px; text-align:center;
    }
    .slot img{width:72px;height:72px;object-fit:contain;background:#000;border-radius:8px;margin-bottom:4px}
    .slot .need{font-size:12px;color:var(--muted)}
    .slot.missing{filter:grayscale(1);opacity:.7}
    .slot.locked{outline:2px dashed #555}

    .craft-actions{margin-top:20px;display:flex;gap:10px;align-items:center; justify-content: center;}
    #craftStartBtn{border:none;border-radius:10px;padding:10px 14px;font-weight:900;background:var(--brand);color:#000;cursor:pointer}
    #craftStartBtn:disabled{opacity:.5;cursor:not-allowed}
    .craft-countdown{font-weight:800;color:var(--muted)}
  </style>
  <style>
    /* === Index Modal === */
    .index-body {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: 16px;
        margin-top: 15px;
    }
    .index-left {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 10px;
        max-height: 70vh;
        overflow-y: auto;
    }
    .index-category-item {
        padding: 10px 12px;
        border: 1px solid var(--card-border);
        border-radius: 10px;
        background: var(--panel);
        cursor: pointer;
        margin-bottom: 8px;
        font-weight: 700;
        transition: background-color 0.2s;
    }
    .index-category-item:hover { background-color: #1a2435; }
    .index-category-item.active {
        outline: 2px solid var(--accent);
        background-color: #162033;
        color: var(--text);
    }
    .index-right {
        max-height: 70vh;
        overflow-y: auto;
        padding-right: 10px;
    }
    #indexGrid {
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }
    #indexGrid .badge, #indexGrid .sub, #indexGrid .buybar, #indexGrid .qty, #indexGrid .price { display: none; }
    #indexGrid .name { text-align: center; margin-bottom: 0; }
    #indexGrid .meta { padding-bottom: 12px; }
  </style>
  <style>
    /* === Themed Index Categories === */
    .index-category-item.category-common {
      background-color: #1a3a2a;
      border-color: #2f6049;
      color: #a7f3d0;
    }
    .index-category-item.category-rare {
      background-color: var(--rare-bg);
      border-color: var(--rare-border);
      color: var(--rare-fg);
    }
    .index-category-item.category-epic {
      background-color: var(--epic-bg);
      border-color: var(--epic-border);
      color: var(--epic-fg);
    }
    .index-category-item.category-legendary {
      background-color: var(--legendary-bg);
      border-color: var(--legendary-border);
      color: var(--legendary-fg);
    }
    .index-category-item.category-mythic {
      background-color: var(--mythic-bg);
      border-color: var(--mythic-border);
      color: var(--mythic-fg);
    }
    .index-category-item.category-brainrotgod {
      background-color: var(--brainrotgod-bg);
      border-color: var(--brainrotgod-border);
      color: var(--brainrotgod-fg);
    }
    .index-category-item.category-secret {
      background-color: var(--secret-bg);
      border-color: var(--secret-border);
      color: var(--secret-fg);
    }
    .index-category-item.category-og {
      background: linear-gradient(45deg, #a855f7, #ec4899, #fde047);
      border-color: #ec4899;
      color: #fff;
      text-shadow: 0 1px 2px #000;
    }
    .index-category-item.active {
      outline: 2px solid var(--accent) !important;
      color: var(--text) !important;
      text-shadow: none !important;
    }
    .index-category-item.category-all.active,
    .index-category-item.active {
      background: #162033 !important;
    }
  </style>
  <style>
    /* === Global Themed Scrollbar === */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--panel);
    }
    ::-webkit-scrollbar-thumb {
      background-color: var(--card-border);
      border-radius: 10px;
      border: 2px solid var(--panel);
    }
    ::-webkit-scrollbar-thumb:hover {
      background-color: var(--accent);
    }
  </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.19.0",
    "marked": "https://aistudiocdn.com/marked@^16.3.0"
  }
}
</script>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <h1>Steal a Brainrot - ONLINE</h1>
      </div>
      <div class="stats">
        <div class="pill" id="balPill"><small>Balance</small> <b id="balance">$0</b></div>
        <button class="btn" id="indexBtn">Index</button>
        <button class="btn" id="craftBtn">Craft</button>
        <button class="btn" id="rebirthBtn">Rebirth</button>
        <button class="btn btn-reset" id="resetBtn" title="Reset progress">Reset</button>
      </div>
    </div>
  </header>

  <main>
    <div class="filters-container">
        <div class="filters" id="filters"></div>
        <div class="slots-counter" id="slotsCounter" hidden></div>
    </div>
    <div class="grid" id="grid"></div>
  </main>

  <footer>
    <p>Place all PNG files into <code>./images/</code>. Filenames must match the character names exactly.</p>
  </footer>

  <div id="indexModal" class="modal" hidden>
    <div class="modal-content">
      <span class="close-btn" id="indexCloseBtn">&times;</span>
      <h2>Character Index</h2>
      <div class="index-body">
        <aside class="index-left" id="indexCategoryList"></aside>
        <section class="index-right">
          <div class="grid" id="indexGrid"></div>
        </section>
      </div>
    </div>
  </div>

  <div id="rebirthModal" class="modal" hidden>
    <div class="modal-content">
      <span class="close-btn" id="rebirthCloseBtn">&times;</span>
      <h2>REBIRTH</h2>
      <p class="rebirth-warning">[WARNING] YOU WILL LOSE ALL CASH AND BRAINROT CHARACTERS YOU OWN WHEN YOU REBIRTH.</p>
      <div id="rebirthInfo"></div>
      <div class="rebirth-level-list" id="rebirthLevelList"></div>
    </div>
  </div>

  <template id="cardTmpl">
    <article class="card">
      <span class="badge">—</span>
      <span class="qty" hidden></span>
      <div class="thumb">
        <img alt="" />
        <div class="placeholder" hidden></div>
      </div>
      <div class="meta">
        <h3 class="name"></h3>
        <div class="sub">
          <span class="income"></span>
          <span class="price"></span>
        </div>
        <div class="buybar">
          <button class="buybtn"></button>
        </div>
      </div>
    </article>
  </template>

  <audio id="cashSound" src="cash-point.ogg" preload="auto"></audio>

  <script>
  const IMG_BASE = './images/';
  const TICK_MS = 100;

  const CHARACTERS = [
    // Common (9)
    { name: 'Noobini Pizzanini', file: 'Noobini Pizzanini.png', cost: 25, cps: 1, rarity: 'Common' },
    { name: 'Lirili Larila', file: 'Lirili Larila.png', cost: 250, cps: 3, rarity: 'Common' },
    { name: 'Tim Cheese', file: 'Tim Cheese.png', cost: 500, cps: 5, rarity: 'Common' },
    { name: 'Fluriflura', file: 'Fluriflura.png', cost: 750, cps: 7, rarity: 'Common' },
    { name: 'Talpa Di Fero', file: 'Talpa Di Fero.png', cost: 1000, cps: 9, rarity: 'Common' },
    { name: 'Svinina Bombardino', file: 'Svinina Bombardino.png', cost: 1200, cps: 10, rarity: 'Common' },
    { name: 'Raccooni Jandelini', file: 'Raccooni Jandelini.png', cost: 1300, cps: 12, rarity: 'Common' },
    { name: 'Pipi Kiwi', file: 'Pipi Kiwi.png', cost: 1500, cps: 13, rarity: 'Common' },
    { name: 'Pipi Corni', file: 'Pipi Corni.png', cost: 1700, cps: 14, rarity: 'Common' },

    // Rare (9)
    { name: 'Trippi Troppi', file: 'Trippi Troppi.png', cost: 2000, cps: 15, rarity: 'Rare' },
    { name: 'Tung Tung Tung Sahur', file: 'Tung Tung Tung Sahur.png', cost: 3000, cps: 25, rarity: 'Rare' },
    { name: 'Gangster Footera', file: 'Gangster Footera.png', cost: 4000, cps: 30, rarity: 'Rare' },
    { name: 'Bandito Bobritto', file: 'Bandito Bobritto.png', cost: 4500, cps: 35, rarity: 'Rare' },
    { name: 'Boneca Ambalabu', file: 'Boneca Ambalabu.png', cost: 5000, cps: 40, rarity: 'Rare' },
    { name: 'Cacto Hipopotamo', file: 'Cacto Hipopotamo.png', cost: 6500, cps: 50, rarity: 'Rare' },
    { name: 'Ta Ta Ta Ta Sahur', file: 'Ta Ta Ta Ta Sahur.png', cost: 7500, cps: 55, rarity: 'Rare' },
    { name: 'Tric Trac Baraboom', file: 'Tric Trac Baraboom.png', cost: 9000, cps: 65, rarity: 'Rare' },
    { name: 'Pipi Avocado', file: 'Pipi Avocado.png', cost: 9500, cps: 70, rarity: 'Rare' },

    // Epic (12)
    { name: 'Cappuccino Assassino', file: 'Cappuccino Assassino.png', cost: 10000, cps: 75, rarity: 'Epic' },
    { name: 'Brr Brr Patapim', file: 'Brr Brr Patapim.png', cost: 15000, cps: 100, rarity: 'Epic' },
    { name: 'Avocadini Antilopini', file: 'Avocadini Antilopini.png', cost: 17500, cps: 115, rarity: 'Epic' },
    { name: 'Trulimero Trulicina', file: 'Trulimero Trulicina.png', cost: 20000, cps: 125, rarity: 'Epic' },
    { name: 'Bambini Crostini', file: 'Bambini Crostini.png', cost: 22500, cps: 135, rarity: 'Epic' },
    { name: 'Bananita Dolphinita', file: 'Bananita Dolphinita.png', cost: 25000, cps: 150, rarity: 'Epic' },
    { name: 'Perochello Lemonchello', file: 'Perochello Lemonchello.png', cost: 27500, cps: 160, rarity: 'Epic' },
    { name: 'Brri Brri Bicus Dicus Bombicus', file: 'Brri Brri Bicus Dicus Bombicus.png', cost: 30000, cps: 175, rarity: 'Epic' },
    { name: 'Avocadini Guffo', file: 'Avocadini Guffo.png', cost: 35000, cps: 225, rarity: 'Epic' },
    { name: 'Ti Ti Ti Sahur', file: 'Ti Ti Ti Sahur.png', cost: 37500, cps: 225, rarity: 'Epic' },
    { name: 'Salamino Penguino', file: 'Salamino Penguino.png', cost: 40000, cps: 250, rarity: 'Epic' },
    { name: 'Penguino Cocosino', file: 'Penguino Cocosino.png', cost: 45000, cps: 300, rarity: 'Epic' },

    // Legendary (14)
    { name: 'Burbaloni Loliloli', file: 'Burbaloni Loliloli.png', cost: 35000, cps: 200, rarity: 'Legendary' },
    { name: 'Chimpanzini Bananini', file: 'Chimpanzini Bananini.png', cost: 50000, cps: 300, rarity: 'Legendary' },
    { name: 'Ballerina Cappuccina', file: 'Ballerina Cappuccina.png', cost: 100000, cps: 500, rarity: 'Legendary' },
    { name: 'Chef Crabracadabra', file: 'Chef Crabracadabra.png', cost: 150000, cps: 600, rarity: 'Legendary' },
    { name: 'Lionel Cactuseli', file: 'Lionel Cactuseli.png', cost: 175000, cps: 650, rarity: 'Legendary' },
    { name: 'Glorbo Fruttodrillo', file: 'Glorbo Fruttodrillo.png', cost: 200000, cps: 750, rarity: 'Legendary' },
    { name: 'Quivioli Ameleonni', file: 'Quivioli Ameleonni.png', cost: 225000, cps: 1000, rarity: 'Legendary' },
    { name: 'Blueberrini Octopusini', file: 'Blueberrini Octopusini.png', cost: 250000, cps: 1000, rarity: 'Legendary' },
    { name: 'Pipi Potato', file: 'Pipi Potato.png', cost: 256000, cps: 1100, rarity: 'Legendary' },
    { name: 'Strawberrelli Flamingelli', file: 'Strawberrelli Flamingelli.png', cost: 275000, cps: 1100, rarity: 'Legendary' },
    { name: 'Cocosini Mama', file: 'Cocosini Mama.png', cost: 285000, cps: 1200, rarity: 'Legendary' },
    { name: 'Pandaccini Bananini', file: 'Pandaccini Bananini.png', cost: 300000, cps: 1200, rarity: 'Legendary' },
    { name: 'Pi Pi Watermelon', file: 'Pi Pi Watermelon.png', cost: 315000, cps: 1200, rarity: 'Legendary' },
    { name: 'Sigma Boy', file: 'Sigma Boy.png', cost: 325000, cps: 1300, rarity: 'Legendary' },

    // Mythic (19)
    { name: 'Frigo Camelo', file: 'Frigo Camelo.png', cost: 300000, cps: 1200, rarity: 'Mythic' },
    { name: 'Orangutini Ananassini', file: 'Orangutini Ananassini.png', cost: 400000, cps: 1700, rarity: 'Mythic' },
    { name: 'Rhino Toasterino', file: 'Rhino Toasterino.png', cost: 450000, cps: 2100, rarity: 'Mythic' },
    { name: 'Bombardiro Crocodilo', file: 'Bombardiro Crocodilo.png', cost: 500000, cps: 2500, rarity: 'Mythic' },
    { name: 'Spioniro Golubiro', file: 'Spioniro Golubiro.png', cost: 750000, cps: 3500, rarity: 'Mythic' },
    { name: 'Bombombini Gusini', file: 'Bombombini Gusini.png', cost: 1000000, cps: 5000, rarity: 'Mythic' },
    { name: 'Zibra Zubra Zibralini', file: 'Zibra Zubra Zibralini.png', cost: 1000000, cps: 6000, rarity: 'Mythic' },
    { name: 'Tigrilini Watermelini', file: 'Tigrilini Watermelini.png', cost: 1000000, cps: 7500, rarity: 'Mythic' },
    { name: 'Avocadorilla', file: 'Avocadorilla.png', cost: 2000000, cps: 7500, rarity: 'Mythic' },
    { name: 'Cavallo Virtuoso', file: 'Cavallo Virtuoso.png', cost: 2500000, cps: 7500, rarity: 'Mythic' },
    { name: 'Te Te Te Sahur', file: 'Te Te Te Sahur.png', cost: 2500000, cps: 9500, rarity: 'Mythic' },
    { name: 'Gorillo Watermelondrillo', file: 'Gorillo Watermelondrillo.png', cost: 3000000, cps: 8000, rarity: 'Mythic' },
    { name: 'Tracoducotulu Delapeladustuz', file: 'Tracoducotulu Delapeladustuz.png', cost: 3000000, cps: 12000, rarity: 'Mythic' },
    { name: 'Tob Tobi Tobi', file: 'Tob Tobi Tobi.png', cost: 3500000, cps: 8500, rarity: 'Mythic' },
    { name: 'Lerulerulerule', file: 'Lerulerulerule.png', cost: 3500000, cps: 8750, rarity: 'Mythic' },
    { name: 'Ganganzelli Trulala', file: 'Ganganzelli Trulala.png', cost: 4000000, cps: 9000, rarity: 'Mythic' },
    { name: 'Carloooo', file: 'Carloooo.png', cost: 4500000, cps: 13500, rarity: 'Mythic' },
    { name: 'Carrotini Brainini', file: 'Carrotini Brainini.png', cost: 4700000, cps: 15000, rarity: 'Mythic' },
    { name: 'Mastodontico Telepiedone', file: 'Mastodontico Telepiedone.png', cost: 4800000, cps: 16000, rarity: 'Mythic' },
    
    // Brainrot God (32)
    { name: 'Cocofanto Elefanto', file: 'Cocofanto Elefanto.png', cost: 5000000, cps: 10000, rarity: 'Brainrot God' },
    { name: 'Girafa Celestre', file: 'Girafa Celestre.png', cost: 7500000, cps: 20000, rarity: 'Brainrot God' },
    { name: 'Gattatino Nyanino', file: 'Gattatino Nyanino.png', cost: 7500000, cps: 35000, rarity: 'Brainrot God' },
    { name: 'Gattatino Neonino', file: 'Gattatino Neonino.png', cost: 7500000, cps: 20000, rarity: 'Brainrot God' },
    { name: 'Chihuanini Taconini', file: 'Chihuanini Taconini.png', cost: 8500000, cps: 45000, rarity: 'Brainrot God' },
    { name: 'Matteo', file: 'Matteo.png', cost: 10000000, cps: 50000, rarity: 'Brainrot God' },
    { name: 'Tralalero Tralala', file: 'Tralalero Tralala.png', cost: 10000000, cps: 50000, rarity: 'Brainrot God' },
    { name: 'Los Crocodillitos', file: 'Los Crocodillitos.png', cost: 12500000, cps: 55000, rarity: 'Brainrot God' },
    { name: 'Tigroligre Frutonni', file: 'Tigroligre Frutonni.png', cost: 15000000, cps: 60000, rarity: 'Brainrot God' },
    { name: 'Odin Din Din Dun', file: 'Odin Din Din Dun.png', cost: 15000000, cps: 75000, rarity: 'Brainrot God' },
    { name: 'Orcalero Orcala', file: 'Orcalero Orcala.png', cost: 15000000, cps: 100000, rarity: 'Brainrot God' },
    { name: 'Alessio', file: 'Alessio.png', cost: 17500000, cps: 85000, rarity: 'Brainrot God' },
    { name: 'Unclito Samito', file: 'Unclito Samito.png', cost: 20000000, cps: 65000, rarity: 'Brainrot God' },
    { name: 'Statutino Libertino', file: 'Statutino Libertino.png', cost: 20000000, cps: 75000, rarity: 'Brainrot God' },
    { name: 'Tipi Topi Taco', file: 'Tipi Topi Taco.png', cost: 20000000, cps: 75000, rarity: 'Brainrot God' },
    { name: 'Tralalita Tralala', file: 'Tralalita Tralala.png', cost: 20000000, cps: 100000, rarity: 'Brainrot God' },
    { name: 'Tukanno Banana', file: 'Tukanno Banana.png', cost: 22500000, cps: 100000, rarity: 'Brainrot God' },
    { name: 'Espresso Signora', file: 'Espresso Signora.png', cost: 25000000, cps: 70000, rarity: 'Brainrot God' },
    { name: 'Trenozosturzzo Turbo 3000', file: 'Trenozosturzzo Turbo 3000.png', cost: 25000000, cps: 150000, rarity: 'Brainrot God' },
    { name: 'Bulbito Bandito Traktorito', file: 'Bulbito Bandito Traktorito.png', cost: 25000000, cps: 205000, rarity: 'Brainrot God' },
    { name: 'Urubini Flamenguini', file: 'Urubini Flamenguini.png', cost: 30000000, cps: 150000, rarity: 'Brainrot God' },
    { name: 'Trippi Troppi Troppa Trippa', file: 'Trippi Troppi Troppa Trippa.png', cost: 30000000, cps: 175000, rarity: 'Brainrot God' },
    { name: 'Gattito Tacoto', file: 'Gattito Tacoto.png', cost: 32500000, cps: 165000, rarity: 'Brainrot God' },
    { name: 'Ballerino Lololo', file: 'Ballerino Lololo.png', cost: 35000000, cps: 200000, rarity: 'Brainrot God' },
    { name: 'Los Tungtungtungcitos', file: 'Los Tungtungtungcitos.png', cost: 37500000, cps: 210000, rarity: 'Brainrot God' },
    { name: 'Pakrahmatmamat', file: 'Pakrahmatmamat.png', cost: 37500000, cps: 215000, rarity: 'Brainrot God' },
    { name: 'Piccione Macchina', file: 'Piccione Macchina.png', cost: 40000000, cps: 225000, rarity: 'Brainrot God' },
    { name: 'Los Bombinitos', file: 'Los Bombinitos.png', cost: 42500000, cps: 220000, rarity: 'Brainrot God' },
    { name: 'Brr Es Teh Patipum', file: 'Brr Es Teh Patipum.png', cost: 45000000, cps: 225000, rarity: 'Brainrot God' },
    { name: 'Cacasito Satalito', file: 'Cacasito Satalito.png', cost: 45000000, cps: 240000, rarity: 'Brainrot God' },
    { name: 'Tartaruga Cisterna', file: 'Tartaruga Cisterna.png', cost: 45000000, cps: 250000, rarity: 'Brainrot God' },
    { name: 'Los Orcalitos', file: 'Los Orcalitos.png', cost: 45000000, cps: 310000, rarity: 'Brainrot God' },

    // Secret (32)
    { name: 'La Vacca Saturno Saturnita', file: 'La Vacca Saturno Saturnita.png', cost: 50000000, cps: 250000, rarity: 'Secret' },
    { name: 'Bisonte Giuppitere', file: 'Bisonte Giuppitere.png', cost: 75000000, cps: 300000, rarity: 'Secret' },
    { name: 'Blackhole Goat', file: 'Blackhole Goat.png', cost: 75000000, cps: 400000, rarity: 'Secret' },
    { name: 'Agarrini Ia Palini', file: 'Agarrini Ia Palini.png', cost: 80000000, cps: 425000, rarity: 'Secret' },
    { name: 'Karkerkar Kurkur', file: 'Karkerkar Kurkur.png', cost: 100000000, cps: 275000, rarity: 'Secret' },
    { name: 'Los Matteos', file: 'Los Matteos.png', cost: 100000000, cps: 300000, rarity: 'Secret' },
    { name: 'Sammyni Spyderini', file: 'Sammyni Spyderini.png', cost: 100000000, cps: 300000, rarity: 'Secret' },
    { name: 'Chimpanzini Spiderini', file: 'Chimpanzini Spiderini.png', cost: 100000000, cps: 325000, rarity: 'Secret' },
    { name: 'Dul Dul Dul', file: 'Dul Dul Dul.png', cost: 150000000, cps: 375000, rarity: 'Secret' },
    { name: 'Torrtuginni Dragonfrutini', file: 'Torrtuginni Dragonfrutini.png', cost: 500000000, cps: 350000, rarity: 'Secret' },
    { name: 'Los Tralaleritos', file: 'Los Tralaleritos.png', cost: 100000000, cps: 750000, rarity: 'Secret' },
    { name: 'Guerriro Digitale', file: 'Guerriro Digitale.png', cost: 120000000, cps: 550000, rarity: 'Secret' },
    { name: 'Las Tralaleritas', file: 'Las Tralaleritas.png', cost: 150000000, cps: 650000, rarity: 'Secret' },
    { name: 'Las Vaquitas Saturnitas', file: 'Las Vaquitas Saturnitas.png', cost: 160000000, cps: 750000, rarity: 'Secret' },
    { name: 'Job Job Job Sahur', file: 'Job Job Job Sahur.png', cost: 175000000, cps: 700000, rarity: 'Secret' },
    { name: 'Graipuss Medussi', file: 'Graipuss Medussi.png', cost: 200000000, cps: 1000000, rarity: 'Secret' },
    { name: 'Los Spyderinis', file: 'Los Spyderinis.png', cost: 250000000, cps: 450000, rarity: 'Secret' },
    { name: 'Nooo My Hotspot', file: 'Nooo My Hotspot.png', cost: 500000000, cps: 2000000, rarity: 'Secret' },
    { name: 'Pot Hotspot', file: 'Pot Hotspot.png', cost: 500000000, cps: 2500000, rarity: 'Secret' },
    { name: 'Chicleteira Bicicleteira', file: 'Chicleteira Bicicleteira.png', cost: 750000000, cps: 3500000, rarity: 'Secret' },
    { name: 'Spaghetti Tualetti', file: 'Spaghetti Tualetti.png', cost: 750000000, cps: 6000000, rarity: 'Secret' },
    { name: 'Esok Sekolah', file: 'Esok Sekolah.png', cost: 750000000, cps: 3000000, rarity: 'Secret' },
    { name: 'Los Nooo My Hotspotsitos', file: 'Los Nooo My Hotspotsitos.png', cost: 1000000000, cps: 5000000, rarity: 'Secret' },
    { name: 'La Grande Combinassion', file: 'La Grande Combinassion.png', cost: 1000000000, cps: 10000000, rarity: 'Secret' },
    { name: 'Los Combinasionas', file: 'Los Combinasionas.png', cost: 2000000000, cps: 15000000, rarity: 'Secret' },
    { name: 'Nuclearo Dinosauro', file: 'Nuclearo Dinosauro.png', cost: 2500000000, cps: 15000000, rarity: 'Secret' },
    { name: 'Los Hotspositos', file: 'Los Hotspositos.png', cost: 3000000000, cps: 25000000, rarity: 'Secret' },
    { name: 'Ketupat Kepat', file: 'Ketupat Kepat.png', cost: 5000000000, cps: 35000000, rarity: 'Secret' },
    { name: 'La Supreme Combinasion', file: 'La Supreme Combinasion.png', cost: 7000000000, cps: 40000000, rarity: 'Secret' },
    { name: 'Ketchuru and Masturu', file: 'Ketchuru and Masturu.png', cost: 7500000000, cps: 42500000, rarity: 'Secret' },
    { name: 'Garama and Madundung', file: 'Garama and Madundung.png', cost: 10000000000, cps: 50000000, rarity: 'Secret' },
    { name: 'Dragon Cannelloni', file: 'Dragon Cannelloni.png', cost: 100000000000, cps: 100000000, rarity: 'Secret' },

    // OG (1)
    { name: 'Strawberry Elephant', file: 'Strawberry Elephant.png', cost: 500000000000, cps: 250000000, rarity: 'OG' }
  ];

  const REBIRTH_LEVELS = [
    { level: 1, cost: 1e6,  characters: ['Trippi Troppi', 'Tung Tung Tung Sahur'], rewards: { cash: 5e3, slots: 0 } },
    { level: 2, cost: 3e6,  characters: ['Boneca Ambalabu', 'Brr Brr Patapim'], rewards: { cash: 10e3, slots: 1 } },
    { level: 3, cost: 12.5e6, characters: ['Trulimero Trulicina', 'Chimpanzini Bananini'], rewards: { cash: 25e3, slots: 1 } },
    { level: 4, cost: 35e6, characters: ['Chef Crabracadabra', 'Glorbo Fruttodrillo'], rewards: { cash: 50e3, slots: 1 } },
    { level: 5, cost: 100e6, characters: ['Frigo Camelo', 'Orangutini Ananassini'], rewards: { cash: 100e3, slots: 1 } },
    { level: 6, cost: 350e6, characters: ['Bombardiro Crocodilo', 'Bombombini Gusini'], rewards: { cash: 250e3, slots: 1 } },
    { level: 7, cost: 1e9,  characters: ['Bombombini Gusini'], rewards: { cash: 500e3, slots: 1 } },
    { level: 8, cost: 5e9,  characters: ['Cocofanto Elefanto'], rewards: { cash: 1e6, slots: 1 } },
    { level: 9, cost: 25e9, characters: ['Girafa Celestre'], rewards: { cash: 5e6, slots: 1 } },
    { level: 10, cost: 250e9, characters: ['Tralalero Tralala'], rewards: { cash: 25e6, slots: 1 } },
    { level: 11, cost: 1e12,  characters: ['Odin Din Din Dun'], rewards: { cash: 45e6, slots: 1 } },
    { level: 12, cost: 7e12,  characters: ['Trenozosturzzo Turbo 3000'], rewards: { cash: 500e6, slots: 1 } },
    { level: 13, cost: 50e12, characters: ['Ballerino Lololo'], rewards: { cash: 1e9, slots: 1 } },
    { level: 14, cost: 100e12, characters: ['Trippi Troppi Troppa Trippa'], rewards: { cash: 2.5e9, slots: 1 } }
  ];

  const $grid = document.getElementById('grid');
  const $balance = document.getElementById('balance');
  const $filters = document.getElementById('filters');
  const $slotsCounter = document.getElementById('slotsCounter');
  const $reset = document.getElementById('resetBtn');
  const $indexBtn = document.getElementById('indexBtn');
  const $indexModal = document.getElementById('indexModal');
  const $indexCloseBtn = document.getElementById('indexCloseBtn');
  const $rebirthBtn = document.getElementById('rebirthBtn');
  const $rebirthModal = document.getElementById('rebirthModal');
  const $rebirthCloseBtn = document.getElementById('rebirthCloseBtn');
  const $rebirthInfo = document.getElementById('rebirthInfo');
  const $rebirthLevelList = document.getElementById('rebirthLevelList');
  const $cashSound = document.getElementById('cashSound');
  const $fullscreenBtn = document.getElementById('fullscreenBtn');


  const SAVE_KEY = 'brainrot_tycoon_v7';
  let state = loadState();

  function playCashSound() {
    $cashSound.currentTime = 0;
    $cashSound.play().catch(error => console.error("Sound play failed:", error));
  }
  
  function loadState() {
    let saved = JSON.parse(localStorage.getItem(SAVE_KEY) || 'null');
    const initialState = { 
        coins: 500, ownedCharacters: [], unlockedIndex: {}, 
        last: Date.now(), filter: 'Common', rebirthLevel: 0, slots: 10 
    };
    if (!saved) {
      return initialState;
    }

    if (saved.owned && !saved.ownedCharacters) {
      saved.ownedCharacters = [];
      for (const id in saved.owned) {
        const count = saved.owned[id] === true ? 1 : saved.owned[id];
        for (let i = 0; i < count; i++) {
          saved.ownedCharacters.push({ id, uid: `${id}-${i}-${Date.now()}`, uncollected: (saved.uncollected?.[id] || 0) / count });
        }
      }
      delete saved.owned;
      delete saved.uncollected;
    }

    saved.ownedCharacters = saved.ownedCharacters || [];
    saved.unlockedIndex = saved.unlockedIndex || {};
    saved.last = saved.last || Date.now();
    saved.filter = saved.filter || 'Common';
    saved.rebirthLevel = saved.rebirthLevel || 0;
    saved.slots = saved.slots || 10;

    const now = Date.now();
    const deltaSec = Math.max(0, Math.floor((now - saved.last) / 1000));
    
    saved.ownedCharacters.forEach(charInstance => {
      const charData = CHARACTERS.find(c => toId(c.name) === charInstance.id);
      if (charData) {
        const earnings = charData.cps * deltaSec;
        charInstance.uncollected = (charInstance.uncollected || 0) + earnings;
      }
    });
    
    saved.last = now;
    return saved;
  }

  function saveState(){ state.last = Date.now(); localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }
  function round2(x){ return Math.round(x*100)/100; }

  function formatNumber(n) {
      if (n >= 1e12) return parseFloat((n / 1e12).toFixed(2)) + 'T';
      if (n >= 1e9) return parseFloat((n / 1e9).toFixed(2)) + 'B';
      if (n >= 1e6) return parseFloat((n / 1e6).toFixed(2)) + 'M';
      if (n >= 1e3) return parseFloat((n / 1e3).toFixed(2)) + 'k';
      return Math.floor(n);
  }
  function formatCoins(n){ return '$' + formatNumber(n); }
  function toId(name){ return name.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/[\s-]+/g, '-'); }
  
  const RARITY_ORDER = ['Owned','Common','Rare','Epic','Legendary','Mythic','Brainrot God','Secret', 'OG'];
  function buildFilters(){
    $filters.innerHTML='';
    $slotsCounter.hidden = state.filter !== 'Owned';
    
    RARITY_ORDER.forEach(r=>{
      const chip=document.createElement('button');
      chip.className='chip'+(state.filter===r?' active':'');
      chip.textContent=r;
      chip.addEventListener('click',()=>{ state.filter=r; buildGrid(); saveState(); });
      $filters.appendChild(chip);
    })
  }

  function buildGrid(){
    $grid.innerHTML='';
    buildFilters(); 
    
    let list = [];
    if(state.filter==='Owned'){
      state.ownedCharacters.forEach(charInstance => {
          const baseChar = CHARACTERS.find(c => toId(c.name) === charInstance.id);
          if (baseChar) {
              list.push({ ...baseChar, ...charInstance });
          }
      });
      $slotsCounter.textContent = `Slots Used: ${state.ownedCharacters.length} / ${state.slots}`;
    } else {
      list = CHARACTERS.filter(c => c.rarity===state.filter && !c.craftOnly);
    }

    if(list.length===0){
      const tip=document.createElement('div');
      tip.style.color='#8fa0b6'; tip.style.padding='12px';
      tip.textContent = state.filter==='Owned'
        ? 'You haven’t bought anything yet. Buy characters from other tabs to see them here.'
        : 'No items here.';
      $grid.appendChild(tip);
    } else {
      list.forEach(c => $grid.appendChild(makeCard(c)));
    }
    refreshHeader();
  }

function makeCard(c){
    const id = toId(c.name);
    
    const tpl=document.getElementById('cardTmpl');
    const $el=tpl.content.firstElementChild.cloneNode(true);
    $el.classList.add(c.rarity.toLowerCase().replace(/\s+/g, ''));
    $el.dataset.id = id;
    if (c.uid) $el.dataset.uid = c.uid;
    if(c.locked){ $el.classList.add('locked'); }

    $el.querySelector('.badge').textContent = c.rarity;
    
    const $qty = $el.querySelector('.qty');
    const count = state.ownedCharacters.filter(char => char.id === id).length;
    $qty.hidden = !(count > 0 && state.filter !== 'Owned');
    $qty.textContent = '×' + count;

    const $img=$el.querySelector('img');
    const $ph=$el.querySelector('.placeholder');
    $img.src=IMG_BASE + c.file;
    $img.alt=c.name;
    $img.addEventListener('error',()=>{ $img.hidden=true;$ph.hidden=false;$ph.textContent=initials(c.name); });

    $el.querySelector('.name').textContent = c.name;
    const $income = $el.querySelector('.income');
    const $price = $el.querySelector('.price');
    const $btn = $el.querySelector('.buybtn');
    
    if (state.filter === 'Owned') {
        $income.textContent = `Generates: ${formatNumber(c.cps)} $/s`;

        const sellLabel = document.createElement('span');
        sellLabel.textContent = `Sell: ${formatCoins(c.cost / 2)}`;
        sellLabel.style.cssText = 'color: var(--danger); font-weight: bold; cursor: pointer;';
        sellLabel.onclick = () => {
            state.coins = round2(state.coins + c.cost / 2);
            const indexToRemove = state.ownedCharacters.findIndex(char => char.uid === c.uid);
            if (indexToRemove > -1) {
                state.ownedCharacters.splice(indexToRemove, 1);
            }
            saveState();
            buildGrid();
        };
        $price.innerHTML = '';
        $price.appendChild(sellLabel);
        
        $btn.textContent = `Collect ${formatCoins(c.uncollected)}`;
        $btn.disabled = c.uncollected < 0.01;
        $btn.onclick = () => {
            const charInstance = state.ownedCharacters.find(char => char.uid === c.uid);
            if (charInstance && charInstance.uncollected > 0) {
                state.coins = round2(state.coins + charInstance.uncollected);
                charInstance.uncollected = 0;
                playCashSound();
                saveState();
                refreshHeader();
                updateCollectButtons(); 
            }
        };
    } else {
        $income.textContent = `Income: ${formatNumber(c.cps)} $/s`;
        $price.textContent  = `Price: ${formatCoins(c.cost)}`;
        
        const hasFreeSlot = state.ownedCharacters.length < state.slots;
        $btn.disabled = state.coins < c.cost || !hasFreeSlot;
        $btn.textContent = hasFreeSlot ? `Buy for ${formatCoins(c.cost)}` : 'Slots Full';

        $btn.onclick = ()=>{
            if (state.coins < c.cost || state.ownedCharacters.length >= state.slots) {
                return; 
            }

            state.coins = round2(state.coins - c.cost);
            const newInstance = { id: id, uid: `${id}-${Date.now()}-${Math.random()}`, uncollected: 0 };
            state.ownedCharacters.push(newInstance);
            state.unlockedIndex[id] = true; 
            playCashSound();
            saveState();
            refreshHeader();
        };
    }
    return $el;
  }

  function updateCollectButtons() {
    if (state.filter !== 'Owned') return;
    document.querySelectorAll('.card[data-uid]').forEach($card => {
        const uid = $card.dataset.uid;
        const charInstance = state.ownedCharacters.find(char => char.uid === uid);
        if (charInstance) {
            const btn = $card.querySelector('.buybtn');
            if (btn) {
                btn.textContent = `Collect ${formatCoins(charInstance.uncollected)}`;
                btn.disabled = charInstance.uncollected < 0.01;
            }
        }
    });
  }

  function buildRebirthList() {
    const nextLevel = state.rebirthLevel + 1;
    const levelData = REBIRTH_LEVELS.find(l => l.level === nextLevel);

    $rebirthInfo.innerHTML = `
        <div><strong>Current Level:</strong> ${state.rebirthLevel}</div>
        <div><strong>Character Slots:</strong> ${state.slots}</div>
        <div><strong>Starting Cash:</strong> ${formatCoins(REBIRTH_LEVELS.find(l=>l.level === state.rebirthLevel)?.rewards.cash || 500)}</div>
    `;

    $rebirthLevelList.innerHTML = '';
    if (!levelData) {
        $rebirthLevelList.innerHTML = '<p>You have reached the maximum Rebirth level!</p>';
        return;
    }

    const item = document.createElement('div');
    item.className = 'rebirth-item';

    let requirementsMet = true;
    
    const hasEnoughCash = state.coins >= levelData.cost;
    if (!hasEnoughCash) requirementsMet = false;
    const progressPercent = Math.min(100, (state.coins / levelData.cost) * 100);
    let cashReqHtml = `
      <div class="cash-requirement ${hasEnoughCash ? 'met' : 'unmet'}">
        <div class="progress-fill" style="width: ${progressPercent}%"></div>
        <span class="progress-text">Cash: ${formatCoins(state.coins)} / ${formatCoins(levelData.cost)}</span>
      </div>
    `;

    let charsReqHtml = '<div class="rebirth-reqs">';
    levelData.characters.forEach(charName => {
        const char = CHARACTERS.find(c => c.name === charName);
        if (!char) return;

        const charId = toId(charName);
        const hasChar = state.ownedCharacters.some(c => c.id === charId);
        if (!hasChar) requirementsMet = false;

        charsReqHtml += `
            <div class="rebirth-char-card ${hasChar ? 'met' : 'unmet'}">
                <img src="${IMG_BASE + char.file}" alt="${char.name}">
                <div>${char.name}</div>
            </div>
        `;
    });
    charsReqHtml += '</div>';

    item.innerHTML = `
        <h3>Level ${levelData.level}</h3>
        <strong>Requirements:</strong>
        ${cashReqHtml}
        ${charsReqHtml}
        <strong>Rewards:</strong>
        <ul>
            <li>Starting Cash: ${formatCoins(levelData.rewards.cash)}</li>
            ${levelData.rewards.slots > 0 ? `<li>+${levelData.rewards.slots} Character Slot(s)</li>` : ''}
        </ul>
        <div class="rebirth-action">
            <button class="btn" id="performRebirthBtn" ${!requirementsMet ? 'disabled' : ''}>Rebirth Now</button>
        </div>
    `;
    $rebirthLevelList.appendChild(item);

    document.getElementById('performRebirthBtn')?.addEventListener('click', () => performRebirth(levelData));
  }

  function performRebirth(levelData) {
    state.rebirthLevel = levelData.level;
    state.slots += levelData.rewards.slots;
    state.coins = levelData.rewards.cash;
    state.ownedCharacters = [];
    
    saveState();
    window.location.reload();
  }

  function initials(name){ return name.split(/\s+/).map(w=>w[0]||'').join('').slice(0,3).toUpperCase(); }

  function refreshHeader(){
    $balance.textContent = formatCoins(state.coins);
    
    document.querySelectorAll('.card:not(#indexGrid .card)').forEach(($card)=>{
      if (state.filter === 'Owned') return;

      const name = $card.querySelector('.name')?.textContent;
      const ch = CHARACTERS.find(x=>x.name===name);
      if(!ch) return;
      const id = toId(ch.name);

      const hasFreeSlot = state.ownedCharacters.length < state.slots;
      const btn = $card.querySelector('.buybtn');
      if(btn) {
        btn.disabled = state.coins < ch.cost || !hasFreeSlot;
        btn.textContent = hasFreeSlot ? `Buy for ${formatCoins(ch.cost)}` : 'Slots Full';
      }
      
      const qty = $card.querySelector('.qty');
      if (qty) {
        const count = state.ownedCharacters.filter(c => c.id === id).length;
        if (count > 0) {
            qty.hidden = false;
            qty.textContent = '×' + count;
        } else {
            qty.hidden = true;
        }
      }
    });
  }

  // --- EVENT LISTENERS & TIMERS ---
  
  $rebirthBtn.onclick = () => { buildRebirthList(); $rebirthModal.hidden = false; };
  $rebirthCloseBtn.onclick = () => { $rebirthModal.hidden = true; };
  window.addEventListener('click', (e) => {
    if (e.target == $indexModal) $indexModal.hidden = true;
    if (e.target == $rebirthModal) $rebirthModal.hidden = true;
  });

  // Fullscreen Logic
  if ($fullscreenBtn) {
    const $fullscreenEnterIcon = $fullscreenBtn.querySelector('.icon-fullscreen-enter');
    const $fullscreenExitIcon = $fullscreenBtn.querySelector('.icon-fullscreen-exit');

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
        });
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
    }

    function updateFullscreenIcon() {
      if (document.fullscreenElement) {
        $fullscreenEnterIcon.style.display = 'none';
        $fullscreenExitIcon.style.display = 'block';
        $fullscreenBtn.title = 'Exit Fullscreen';
      } else {
        $fullscreenEnterIcon.style.display = 'block';
        $fullscreenExitIcon.style.display = 'none';
        $fullscreenBtn.title = 'Enter Fullscreen';
      }
    }

    $fullscreenBtn.addEventListener('click', toggleFullscreen);
    document.addEventListener('fullscreenchange', updateFullscreenIcon);
    updateFullscreenIcon();
  }

  setInterval(()=>{
    const timeDelta = TICK_MS / 1000;
    state.ownedCharacters.forEach(charInstance => {
      if (charInstance.locked) return;
      const charData = CHARACTERS.find(c => toId(c.name) === charInstance.id);
      if (charData) {
        const earnings = charData.cps * timeDelta;
        charInstance.uncollected = (charInstance.uncollected || 0) + earnings;
      }
    });
    updateCollectButtons();
  }, TICK_MS);
  setInterval(saveState,3000);
  document.getElementById('resetBtn').onclick=()=>{ if(confirm('Reset progress? This will reset everything including Rebirths!')){ localStorage.removeItem(SAVE_KEY); window.location.reload(); } };

  // --- NEW: INDEX MODAL LOGIC ---
  let currentIndexCategory = 'ALL';
  const INDEX_CATEGORIES = ['ALL', 'COMMON', 'RARE', 'EPIC', 'LEGENDARY', 'MYTHIC', 'BRAINROT GOD', 'SECRET', 'OG'];

  function renderIndexCategories() {
      const $categoryList = document.getElementById('indexCategoryList');
      if (!$categoryList) return;
      $categoryList.innerHTML = '';
      INDEX_CATEGORIES.forEach(cat => {
          const item = document.createElement('div');
          item.className = 'index-category-item';
          if (cat === currentIndexCategory) item.classList.add('active');
          item.textContent = cat === 'ALL' ? 'All' : cat.charAt(0) + cat.slice(1).toLowerCase();
          
          item.addEventListener('click', () => {
              currentIndexCategory = cat;
              $categoryList.querySelector('.active')?.classList.remove('active');
              item.classList.add('active');
              renderIndexGrid(cat);
          });
          $categoryList.appendChild(item);
      });
  }
  function renderIndexGrid(category) {
      const $indexGrid = document.getElementById('indexGrid');
      if (!$indexGrid) return;
      $indexGrid.innerHTML = '';

      const charactersToShow = (category === 'ALL')
          ? CHARACTERS
          : CHARACTERS.filter(c => c.rarity.toUpperCase().replace(/\s+/g, '') === category.replace(/\s+/g, ''));

      charactersToShow.forEach(c => {
          const tpl = document.getElementById('cardTmpl');
          const $el = tpl.content.firstElementChild.cloneNode(true);
          const isUnlocked = state.unlockedIndex[toId(c.name)] === true;

          $el.classList.add(c.rarity.toLowerCase().replace(/\s+/g, ''));
          $el.querySelector('.badge').textContent = c.rarity;
          $el.querySelector('.name').textContent = c.name;
          
          const $img = $el.querySelector('img');
          const $ph = $el.querySelector('.placeholder');
          $img.src = IMG_BASE + c.file;
          $img.alt = c.name;
          $img.addEventListener('error', () => { $img.hidden = true; $ph.hidden = false; $ph.textContent = initials(c.name); });

          if (!isUnlocked) {
              $img.style.filter = 'brightness(0) grayscale(1)';
              $el.querySelector('.badge').style.filter = 'grayscale(1)';
          }
          $indexGrid.appendChild($el);
      });
  }
  function openIndexModal() {
      renderIndexCategories();
      renderIndexGrid(currentIndexCategory);
      $indexModal.hidden = false;
  }
  $indexBtn.onclick = openIndexModal;
  $indexCloseBtn.onclick = () => { $indexModal.hidden = true; };


  // Init
  if(!RARITY_ORDER.includes(state.filter)) state.filter='Common';
  buildGrid();
  refreshHeader();
  </script>

<div id="craftModal" class="modal" hidden>
  <div class="modal-content craft">
    <span class="close-btn" id="craftCloseBtn">&times;</span>
    <div class="craft-header">
      <h2>Craft Brainrots</h2>
      <div class="craft-timer">
        Refreshes in <span id="craftRefreshCountdown">15:00</span>
      </div>
    </div>
    <div class="craft-body">
      <aside class="craft-left">
        <div id="craftList" class="craft-list"></div>
      </aside>
      <section class="craft-right">
        <div id="craftDetail" class="craft-detail">
          <div class="craft-detail-empty">Select a craft on the left.</div>
        </div>
      </section>
    </div>
  </div>
</div>
<script>
{ // Scoping block for Craft Machine
// === Craft Machine (Final Version) ===

// DOM Elements
const $craftBtn = document.getElementById('craftBtn');
const $craftModal = document.getElementById('craftModal');
const $craftCloseBtn = document.getElementById('craftCloseBtn');
const $craftList = document.getElementById('craftList');
const $craftDetail = document.getElementById('craftDetail');
const $craftRefreshCountdown = document.getElementById('craftRefreshCountdown');

// State Initialization
state.crafts = state.crafts || [];           
state.craftPool = state.craftPool || [];     
state.craftNextRefreshAt = state.craftNextRefreshAt || (Date.now() + 15 * 60 * 1000);

// Craft-only Characters Data
const CRAFT_CHARACTERS = [
  { name:'Bandito Axolito', file:'Bandito Axolito.png', cost:12500, cps:90, rarity:'Epic', craftOnly:true },
  { name:'Malame Amarele', file:'Malame Amarele.png', cost:23500, cps:140, rarity:'Epic', craftOnly:true },
  { name:'Mangolini Parrocini', file:'Mangolini Parrocini.png', cost:38500, cps:235, rarity:'Epic', craftOnly:true },
  { name:'Tirilikalika Tirilikalako', file:'Tirilikalika Tirilikalako.png', cost:75000, cps:450, rarity:'Legendary', craftOnly:true },
  { name:'Caramello Filtrello', file:'Caramello Filtrello.png', cost:255000, cps:1000, rarity:'Legendary', craftOnly:true },
  { name:'Signore Carapace', file:'Signore Carapace.png', cost:320000, cps:1300, rarity:'Legendary', craftOnly:true },
  { name:'Brutto Gialutto', file:'Brutto Gialutto.png', cost:600000, cps:3000, rarity:'Mythic', craftOnly:true },
  { name:'Los Noobinis', file:'Los Noobinis.png', cost:4300000, cps:12500, rarity:'Mythic', craftOnly:true },
  { name:'Gorillo Subwoofero', file:'Gorillo Subwoofero.png', cost:2700000, cps:7700, rarity:'Mythic', craftOnly:true },
  { name:'Las Cappucinas', file:'Las Cappucinas.png', cost:82500000, cps:135000, rarity:'Brainrot God', craftOnly:true },
  { name:'Anpali Babel', file:'Anpali Babel.png', cost:48000000, cps:280000, rarity:'Brainrot God', craftOnly:true },
  { name:'Orcalita Orcala', file:'Orcalita Orcala.png', cost:45000000, cps:240000, rarity:'Brainrot God', craftOnly:true },
  { name:'Piccionetta Machina', file:'Piccionetta Machina.png', cost:47000000, cps:270000, rarity:'Brainrot God', craftOnly:true },
  { name:'Antonio', file:'Antonio.png', cost:6000000, cps:18500, rarity:'Brainrot God', craftOnly:true },
  { name:'La Karkerkar Combinasion', file:'La Karkerkar Combinasion.png', cost:160000000, cps:17500000, rarity:'Secret', craftOnly:true },
  { name:'La Sahur Combinasion', file:'La Sahur Combinasion.png', cost:550000000, cps:2000000, rarity:'Secret', craftOnly:true },
  { name:'Tralaledon', file:'Tralaledon.png', cost:3000000000, cps:27500000, rarity:'Secret', craftOnly:true },
  { name:'Fragelo La La La', file:'Fragelo La La La.png', cost:125000000, cps:450000, rarity:'Secret', craftOnly:true },
  { name:'Los Bros', file:'Los Bros.png', cost:2600000000, cps:24000000, rarity:'Secret', craftOnly:true },
  { name:'Trenzostruzzo Turbo 4000', file:'Trenzostruzzo Turbo 4000.png', cost:100000000, cps:310000, rarity:'Secret', craftOnly:true },
];
CRAFT_CHARACTERS.forEach(c => { if (!CHARACTERS.find(x => x.name === c.name)) CHARACTERS.push(c); });

// Crafting Constants
const CRAFT_TIME = {
  'Epic': 7*60, 'Legendary': 15*60, 'Mythic': 30*60, 'Brainrot God': 45*60, 'Secret': 90*60
};
const CRAFT_RECIPES = [
  { name:'Bandito Axolito', rarity:'Epic', req:[{n:'Trippi Troppi',q:2},{n:'Bandito Bobritto',q:2}] },
  { name:'Malame Amarele', rarity:'Epic', req:[{n:'Tung Tung Tung Sahur',q:2},{n:'Ta Ta Ta Ta Sahur',q:1},{n:'Brr Brr Patapim',q:1}] },
  { name:'Mangolini Parrocini', rarity:'Epic', req:[{n:'Pipi Kiwi',q:1},{n:'Pipi Avocado',q:1},{n:'Boneca Ambalabu',q:1},{n:'Perochello Lemonchello',q:1}] },
  { name:'Tirilikalika Tirilikalako', rarity:'Legendary', req:[{n:'Cacto Hipopotamo',q:1},{n:'Penguino Cocosino',q:1},{n:'Cappuccino Assassino',q:2}] },
  { name:'Caramello Filtrello', rarity:'Legendary', req:[{n:'Salamino Penguino',q:1},{n:'Bananita Dolphinita',q:1},{n:'Chimpanzini Bananini',q:1},{n:'Burbaloni Loliloli',q:1}] },
  { name:'Signore Carapace', rarity:'Legendary', req:[{n:'Brri Brri Bicus Dicus Bombicus',q:1},{n:'Glorbo Fruttodrillo',q:1},{n:'Penguino Cocosino',q:2}] },
  { name:'Brutto Gialutto', rarity:'Mythic', req:[{n:'Salamino Penguino',q:2},{n:'Blueberrini Octopusini',q:1},{n:'Rhino Toasterino',q:1}] },
  { name:'Los Noobinis', rarity:'Mythic', req:[{n:'Noobini Pizzanini',q:3},{n:'Carrotini Brainini',q:1}] },
  { name:'Gorillo Subwoofero', rarity:'Mythic', req:[{n:'Spioniro Golubiro',q:2},{n:'Orangutini Ananassini',q:2}] },
  { name:'Las Cappucinas', rarity:'Brainrot God', req:[{n:'Ballerina Cappuccina',q:2},{n:'Tralalita Tralala',q:2}] },
  { name:'Anpali Babel', rarity:'Brainrot God', req:[{n:'Te Te Te Sahur',q:3},{n:'Mastodontico Telepiedone',q:1}] },
  { name:'Orcalita Orcala', rarity:'Brainrot God', req:[{n:'Orcalero Orcala',q:2},{n:'Tralalita Tralala',q:1},{n:'Espresso Signora',q:1}] },
  { name:'Piccionetta Machina', rarity:'Brainrot God', req:[{n:'Piccione Macchina',q:1},{n:'Matteo',q:1},{n:'Gattatino Nyanino',q:2}] },
  { name:'Antonio', rarity:'Brainrot God', req:[{n:'Ganganzelli Trulala',q:2},{n:'Bombardiro Crocodilo',q:1},{n:'Frigo Camelo',q:1}] },
  { name:'La Karkerkar Combinasion', rarity:'Secret', req:[{n:'La Grande Combinassion',q:2},{n:'Karkerkar Kurkur',q:2}] },
  { name:'La Sahur Combinasion', rarity:'Secret', req:[{n:'Ta Ta Ta Ta Sahur',q:1},{n:'Te Te Te Sahur',q:1},{n:'Graipuss Medussi',q:1},{n:'Job Job Job Sahur',q:1}] },
  { name:'Tralaledon', rarity:'Secret', req:[{n:'Tralalero Tralala',q:3},{n:'Nuclearo Dinosauro',q:1}] },
  { name:'Fragelo La La La', rarity:'Secret', req:[{n:'Odin Din Din Dun',q:3},{n:'Sammyni Spyderini',q:1}] },
  { name:'Los Bros', rarity:'Secret', req:[{n:'Los Tungtungtungcitos',q:1},{n:'Los Combinasionas',q:2},{n:'Los Tralaleritos',q:1}] },
  { name:'Trenzostruzzo Turbo 4000', rarity:'Secret', req:[{n:'Girafa Celestre',q:2},{n:'Trenozosturzzo Turbo 3000',q:2}] },
];

// Helper Functions
const charByName = (name) => CHARACTERS.find(c => c.name === name);
const ownedInstancesByName = (name) => {
    const id = toId(name);
    return state.ownedCharacters.filter(ci => ci.id === id && !ci.locked);
};
const formatCountdown = (ms) => {
    const s = Math.max(0, Math.floor(ms / 1000));
    return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
};
const formatTimeByRarity = (r) => {
    const seconds = CRAFT_TIME[r] || 5400; // Default to 90 mins
    return `${Math.floor(seconds/60)}m ${String(seconds%60).padStart(2,'0')}s`;
};

// Main Crafting Logic
function refreshCraftPool(force = false) {
    const now = Date.now();
    if (force || now >= state.craftNextRefreshAt || !state.craftPool.length) {
        const pool = [...CRAFT_RECIPES];
        for (let i = pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
        }
        state.craftPool = pool.slice(0, 5).map(x => x.name);
        state.craftNextRefreshAt = now + 15 * 60 * 1000;
        saveState();
    }
    renderCraftUI();
}

function renderCraftUI() {
    const poolObjects = state.craftPool.map(name => {
        const recipe = CRAFT_RECIPES.find(r => r.name === name);
        return { ...charByName(name), ...recipe };
    });
    
    renderCraftList(poolObjects);
    if (poolObjects.length > 0) {
        const activeItemName = document.querySelector('.craft-list-item.active .name')?.textContent;
        const activeRecipe = poolObjects.find(p => p.name === activeItemName) || poolObjects[0];
        renderCraftDetail(activeRecipe);
    } else {
        $craftDetail.innerHTML = `<div class="craft-detail-empty">No crafts available.</div>`;
    }
}

function renderCraftList(pool) {
    $craftList.innerHTML = '';
    pool.forEach((rec, idx) => {
        const item = document.createElement('div');
        item.className = 'craft-list-item';
        item.dataset.name = rec.name;
        if (idx === 0) item.classList.add('active');
        
        item.innerHTML = `
            <div class="icon"><img src="${IMG_BASE}${rec.file || ''}" alt="${rec.name}"></div>
            <div class="name">${rec.name}</div>
        `;
        
        item.addEventListener('click', () => {
            document.querySelector('.craft-list-item.active')?.classList.remove('active');
            item.classList.add('active');
            renderCraftDetail(rec);
        });
        $craftList.appendChild(item);
    });
}

function renderCraftDetail(rec) {
    const { name, rarity, req, file, cps } = rec;
    const canCraft = req.every(r => ownedInstancesByName(r.n).length >= r.q);
    const activeCrafts = state.crafts.filter(c => c.name === name);

    let slotsHtml = '';
    req.forEach(r => {
        const have = ownedInstancesByName(r.n).length;
        const base = charByName(r.n);
        for (let i = 0; i < r.q; i++) {
            const missing = i >= have;
            slotsHtml += `
                <div class="slot ${missing ? 'missing' : ''}">
                    <img src="${IMG_BASE + (base?.file || '')}" alt="${r.n}">
                    <div class="need">${r.n}</div>
                </div>`;
        }
    });

    $craftDetail.innerHTML = `
        <h3>${name}</h3>
        <img class="craft-main-image" src="${IMG_BASE + file}" alt="${name}">
        <div class="craft-stats">
            <span>Rarity: <b>${rarity}</b></span>
            <span>Time: <b>${formatTimeByRarity(rarity)}</b></span>
            <span>Income: <b>${formatNumber(cps)} $/s</b></span>
        </div>
        <div class="craft-reqs">
            <h4>Brainrots Required</h4>
            <div class="slot-row">${slotsHtml}</div>
        </div>
        <div class="craft-actions">
            <button id="craftStartBtn" ${!canCraft ? 'disabled' : ''}>Craft</button>
            <div class="craft-countdown" id="craftActiveList">${
                activeCrafts.map(c => `<div>Crafting… <span data-ends="${c.endsAt}">${formatCountdown(c.endsAt - Date.now())}</span></div>`).join('')
            }</div>
        </div>`;
    
    document.getElementById('craftStartBtn')?.addEventListener('click', () => startCraft(rec));
}

function startCraft(rec) {
    const ingredients = [];
    for (const r of rec.req) {
        const available = ownedInstancesByName(r.n);
        if (available.length < r.q) {
            alert('Missing required Brainrots.');
            return;
        }
        ingredients.push(...available.slice(0, r.q));
    }

    const ingredientUIDs = ingredients.map(i => i.uid);
    ingredientUIDs.forEach(uid => {
        const inst = state.ownedCharacters.find(ci => ci.uid === uid);
        if (inst) inst.locked = true;
    });

    state.crafts.push({
        name: rec.name,
        endsAt: Date.now() + (CRAFT_TIME[rec.rarity] || 5400) * 1000,
        lockUids: ingredientUIDs
    });
    
    saveState();
    renderCraftUI();
}

function tickCrafts() {
    const now = Date.now();
    let changed = false;
    
    document.querySelectorAll('#craftActiveList span[data-ends]').forEach(span => {
        span.textContent = formatCountdown(Number(span.dataset.ends) - now);
    });

    const stillCrafting = [];
    for (const craft of state.crafts) {
        if (now >= craft.endsAt) {
            changed = true;
            craft.lockUids.forEach(uid => {
                const index = state.ownedCharacters.findIndex(ci => ci.uid === uid);
                if (index > -1) state.ownedCharacters.splice(index, 1);
            });
            const result = charByName(craft.name);
            if (result) {
                const id = toId(result.name);
                state.ownedCharacters.push({ id, uid: `${id}-${now}-${Math.random()}`, uncollected: 0 });
                state.unlockedIndex[id] = true;
                playCashSound();
            }
        } else {
            stillCrafting.push(craft);
        }
    }

    if (changed) {
        state.crafts = stillCrafting;
        saveState();
        renderCraftUI();
        if (state.filter === 'Owned') buildGrid();
    }

    if ($craftRefreshCountdown) {
        $craftRefreshCountdown.textContent = formatCountdown(state.craftNextRefreshAt - now);
    }
    if (now >= state.craftNextRefreshAt) {
        refreshCraftPool(true);
    }
}

// Event Listeners
$craftBtn.addEventListener('click', () => {
    refreshCraftPool();
    $craftModal.hidden = false;
});
$craftCloseBtn.addEventListener('click', () => { $craftModal.hidden = true; });
window.addEventListener('click', e => { if (e.target === $craftModal) $craftModal.hidden = true; });

// Global tick interval
setInterval(tickCrafts, 1000);
}
</script>

  <button id="fullscreenBtn" class="fab" title="Toggle Fullscreen">
    <svg class="icon-fullscreen-enter" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
      <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path>
    </svg>
    <svg class="icon-fullscreen-exit" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
      <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"></path>
    </svg>
  </button>
</body>
</html>
